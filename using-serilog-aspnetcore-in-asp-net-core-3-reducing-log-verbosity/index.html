<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用Serilog减少日志的详细程度"><meta name="keywords" content="ASP.NET CORE,ASP.NET CORE 3.0,日志,Serilog"><meta name="author" content="Akini Xu"><meta name="copyright" content="Akini Xu"><title>使用Serilog减少日志的详细程度 | 嘉阅</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?90338b924a229bc3b13945771720922c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-157143555-1', 'auto');
ga('send', 'pageview');</script><link rel="dns-prefetch" href="http://ta.qq.com"><script>(function() {
   var hm = document.createElement("script");
   hm.src = "https://tajs.qq.com/stats?sId=66513060";
   var s = document.getElementsByTagName("script")[0];
   s.parentNode.insertBefore(hm, s);
 })();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"58VSOBFQHT","apiKey":"055694feb7a00213dd437a9331d74cfb","indexName":"iBestReadBlog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#当未使用Serilog时的请求日志"><span class="toc-number">1.</span> <span class="toc-text">当未使用Serilog时的请求日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在应用程序中添加Serilog引用"><span class="toc-number">2.</span> <span class="toc-text">在应用程序中添加Serilog引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启Serilog中间件RequestLoggingMiddleware"><span class="toc-number">3.</span> <span class="toc-text">开启Serilog中间件RequestLoggingMiddleware</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.ibestread.com/img/akinix_logo.jpg"></div><div class="author-info__name text-center">Akini Xu</div><div class="author-info__description text-center">Best Read For You</div><div class="follow-button"><a href="https://github.com/akinix" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">21</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">34</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.ibestread.com/img/top_background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">嘉阅</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">使用Serilog减少日志的详细程度</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-13</time><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">2.4k</span><span class="post-meta__separator">|</span><span>阅读时长: 10 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>译者:  <a href="/">Akini Xu</a></p>
<p>原文:  <a href="https://andrewlock.net/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/" target="_blank" rel="noopener">Reducing log verbosity with Serilog RequestLogging</a></p>
<p>作者:  <a href="https://andrewlock.net/about/" target="_blank" rel="noopener">Andrew Lock</a></p>
</blockquote>
<p>此文是<a href="/using-serilog-aspnetcore-in-asp-net-core-3/">在ASP.NET Core 3.0中使用Serilog</a>第1篇:</p>
<ol>
<li><a href="/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">使用Serilog减少日志的详细程度</a></li>
<li><a href="/using-serilog-aspnetcore-in-asp-net-core-3-logging-the-selected-endpoint-name-with-serilog/">使用Serilog记录所选的端点</a></li>
<li><a href="/using-serilog-aspnetcore-in-asp-net-core-3-logging-mvc-propertis-with-serilog/">使用Serilog记录MVC属性</a></li>
<li><a href="/using-serilog-aspnetcore-in-asp-net-core-3-excluding-health-check-endpoints-from-serilog-request-logging/">在Serilog日志中排除健康检查日志</a></li>
</ol>
<a id="more"></a>
<h2 id="当未使用Serilog时的请求日志">当未使用Serilog时的请求日志</h2>
<p>使用<code>dotnet new webapp</code>创建一个ASP.NET Core 3.0 Razor的应用程序。 其中<em>Program.cs</em>，代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        CreateHostBuilder(args).Build().Run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">        Host.CreateDefaultBuilder(args)</span><br><span class="line">            .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<em>Startup.cs</em>的代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">    &#123;</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        app.UseExceptionHandler(<span class="string">"/Error"</span>);</span><br><span class="line">        app.UseHsts();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    app.UseHttpsRedirection();</span><br><span class="line">    app.UseStaticFiles();</span><br><span class="line">    app.UseRouting();</span><br><span class="line">    app.UseAuthorization();</span><br><span class="line">    app.UseEndpoints(endpoints =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        endpoints.MapRazorPages();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动程序后，会自动访问到应用程序首页。在控制台中，可以看到每次请求都产生了大量的日志，下面只是请求一次首页而产生的日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]</span><br><span class="line">      Request starting HTTP/2 GET https://localhost:5001/</span><br><span class="line">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]</span><br><span class="line">      Executing endpoint <span class="string">'/Index'</span></span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[3]</span><br><span class="line">      Route matched with &#123;page = <span class="string">"/Index"</span>&#125;. Executing page /Index</span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[101]</span><br><span class="line">      Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid</span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[102]</span><br><span class="line">      Executed handler method OnGet, returned result .</span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[103]</span><br><span class="line">      Executing an implicit handler method - ModelState is Valid</span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[104]</span><br><span class="line">      Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.</span><br><span class="line">info: Microsoft.AspNetCore.Mvc.RazorPages.Infrastructure.PageActionInvoker[4]</span><br><span class="line">      Executed page /Index <span class="keyword">in</span> 221.07510000000002ms</span><br><span class="line">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]</span><br><span class="line">      Executed endpoint <span class="string">'/Index'</span></span><br><span class="line">info: Microsoft.AspNetCore.Hosting.Diagnostics[2]</span><br><span class="line">      Request finished <span class="keyword">in</span> 430.9383ms 200 text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>1次请求会产生10条日志。 <code>Development</code>环境中，<em>Microsoft</em>名称空间下的日志记录级别是“Information”及以上。 如果我们切换到<code>Production</code>环境，Microsoft名称空间下的日志记录级别是“Warning”。 现在导航到默认主页会生成以下日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>啥都没有。上一次运行时，产生的日志都位于Microsoft命名空间下，并且属于“Information”级别，所以它们全部被过滤掉了。 就个人而言，觉得这种处理方式有点过了。如果没有其它日志时，生产环境下最好还是应该输出点日志。</p>
<p>可以通过针对特定的名称空间指定日志级别方式来处理这个问题。例如，调整<em>Microsoft.AspNetCore.Mvc.RazorPages</em>名称空间的日志级别为“Warning”，调整<em>Microsoft</em>名称空间的日志级别为&quot;Information&quot;，下面是修改后的日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]</span><br><span class="line">      Request starting HTTP/2 GET https://localhost:5001/</span><br><span class="line">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]</span><br><span class="line">      Executing endpoint <span class="string">'/Index'</span></span><br><span class="line">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]</span><br><span class="line">      Executed endpoint <span class="string">'/Index'</span></span><br><span class="line">info: Microsoft.AspNetCore.Hosting.Diagnostics[2]</span><br><span class="line">      Request finished <span class="keyword">in</span> 184.788ms 200 text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>虽然日志中包含了URL、HTTP方法、时间信息、端点等信息。 但是，仍然有让人头疼的地方是生成了4行日志消息。</p>
<p>Serilog的<code>RequestLoggingMiddleware</code>中间件可以解决的问题。只创建一条包含所有相关信息的“摘要”日志消息。</p>
<h2 id="在应用程序中添加Serilog引用">在应用程序中添加Serilog引用</h2>
<p>使用Serilog的<code>RequestLoggingMiddleware</code>中间件，只需要添加对Serilog的引用即可。在本节中，将介绍如何添加Serilog到ASP.NET Core的应用程序中。 如果您已经安装了Serilog，请跳至下一部分。</p>
<p><a href="https://andrewlock.net/adding-serilog-to-the-asp-net-core-generic-host/" target="_blank" rel="noopener">之前的文章</a>介绍了如何将Serilog添加到通用主机应用程序中，当时的ASP.NET Core 2.x已经在通用主机基础架构上进行了重构，因此，在ASP.NET Core 3.0中添加Serilog的方法与与之前非常相似。 本文是参照<a href="https://github.com/serilog/serilog-aspnetcore" target="_blank" rel="noopener">Serilog.AspNetCore GitHub</a>的建议来操作的（同时参考了<a href="https://nblumhardt.com/2019/10/serilog-in-aspnetcore-3" target="_blank" rel="noopener">Nicholas Blumhardt的帖子</a>）。</p>
<p>首先安装<em>Serilog.AspNetCore NuGet</em>包，为了方便查看日志，再添加命令行接收器和<a href="https://datalust.co/seq" target="_blank" rel="noopener">Seq</a>接收器。在命令行中执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dotnet add package Serilog.AspNetCore</span><br><span class="line">dotnet add package Serilog.Sinks.Console</span><br><span class="line">dotnet add package Serilog.Sinks.Seq</span><br></pre></td></tr></table></figure>
<p>用Serilog替换默认日志有多种方法。但是推荐在程序一开始就进行替换，比如在<code>Program.Main</code>中配置Serilog。 <em>Program.cs</em>的代码稍微变得多些：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Additional required namespaces</span></span><br><span class="line"><span class="keyword">using</span> Serilog;</span><br><span class="line"><span class="keyword">using</span> Serilog.Events;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Create the Serilog logger, and configure the sinks</span></span><br><span class="line">        Log.Logger = <span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">            .MinimumLevel.Debug()</span><br><span class="line">            .MinimumLevel.Override(<span class="string">"Microsoft"</span>, LogEventLevel.Information)</span><br><span class="line">            .Enrich.FromLogContext()</span><br><span class="line">            .WriteTo.Console()</span><br><span class="line">            .WriteTo.Seq(<span class="string">"http://localhost:5341"</span>)</span><br><span class="line">            .CreateLogger();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Wrap creating and running the host in a try-catch block</span></span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            Log.Information(<span class="string">"Starting host"</span>);</span><br><span class="line">            CreateHostBuilder(args).Build().Run();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">        &#123;</span><br><span class="line">            Log.Fatal(ex, <span class="string">"Host terminated unexpectedly"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            Log.CloseAndFlush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IHostBuilder <span class="title">CreateHostBuilder</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">        Host.CreateDefaultBuilder(args)</span><br><span class="line">            .UseSerilog() <span class="comment">// &lt;- Add this line</span></span><br><span class="line">            .ConfigureWebHostDefaults(webBuilder =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                webBuilder.UseStartup&lt;Startup&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样写的好处是，当<em>appsettings.json</em>文件缺失、或其内部日志配置缺失时，任然可以输出日志。再启动你的程序，会看到10条日志消息，格式略有差异：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[13:30:27 INF] Request starting HTTP/2 GET https://localhost:5001/  </span><br><span class="line">[13:30:27 INF] Executing endpoint <span class="string">'/Index'</span></span><br><span class="line">[13:30:27 INF] Route matched with &#123;page = <span class="string">"/Index"</span>&#125;. Executing page /Index</span><br><span class="line">[13:30:27 INF] Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid</span><br><span class="line">[13:30:27 INF] Executed handler method OnGet, returned result .</span><br><span class="line">[13:30:27 INF] Executing an implicit handler method - ModelState is Valid</span><br><span class="line">[13:30:27 INF] Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.</span><br><span class="line">[13:30:27 INF] Executed page /Index <span class="keyword">in</span> 168.28470000000002ms</span><br><span class="line">[13:30:27 INF] Executed endpoint <span class="string">'/Index'</span></span><br><span class="line">[13:30:27 INF] Request finished <span class="keyword">in</span> 297.0663ms 200 text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>这样做好像没有解决我们第一节所说的问题，日志数量还是10条，并没有减少。不要慌，因为我们还没有开启 <code>RequestLoggingMiddleware</code> 中间件。</p>
<h2 id="开启Serilog中间件RequestLoggingMiddleware">开启Serilog中间件RequestLoggingMiddleware</h2>
<p><code>RequestLoggingMiddleware</code>中间件在<em>Serilog.AspNetCore</em>包中，它对每个请求仅生成一条“摘要”日志消息。 添加此中间件很简单。 在您的<code>Startup</code>类中，调用<code>UseSerilogRequestLogging()</code>即可：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Additional required namespace</span></span><br><span class="line"><span class="keyword">using</span> Serilog;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ... Error handling/HTTPS middleware</span></span><br><span class="line">    app.UseStaticFiles();</span><br><span class="line"></span><br><span class="line">    app.UseSerilogRequestLogging(); <span class="comment">// &lt;-- Add this line</span></span><br><span class="line"></span><br><span class="line">    app.UseRouting();</span><br><span class="line">    app.UseAuthorization();</span><br><span class="line">    app.UseEndpoints(endpoints =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        endpoints.MapRazorPages();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，ASP.NET Core管道内的中间件顺序很重要。 当请求到达<code>RequestLoggingMiddleware</code>时，中间件开始计时，并转交给后续中间件进行处理。 当后续中间件最终生成响应（或引发异常）时，响应通过中间件管道返回到请求记录器，该记录器记录结果并写入摘要日志消息。</p>
<p>只有经过了<code>RequestLoggingMiddleware</code>中间件的请求，Serilog才会记录日志。 在上面的示例中，先添加<code>StaticFilesMiddleware</code>，再添加<code>RequestLoggingMiddleware</code>。 <code>UseStaticFiles</code>将请求短路，没有经过后续中间件，直接返回了响应，所以不会被Serilog记录。 通常我们也希望不记录与静态文件相关日志，如果您想记录，只需把<code>UseSerilogRequestLogging()</code>移到<code>UseStaticFiles()</code>之前。</p>
<p>我们再次运行该应用程序，仍然会看到原始的10条日志消息，同时还一条由Serilog的<code>RequestLoggingMiddleware</code>的产生的，倒数第二条消息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Standard logging from ASP.NET Core infrastructure</span></span><br><span class="line">[14:15:44 INF] Request starting HTTP/2 GET https://localhost:5001/  </span><br><span class="line">[14:15:44 INF] Executing endpoint <span class="string">'/Index'</span></span><br><span class="line">[14:15:45 INF] Route matched with &#123;page = <span class="string">"/Index"</span>&#125;. Executing page /Index</span><br><span class="line">[14:15:45 INF] Executing handler method SerilogRequestLogging.Pages.IndexModel.OnGet - ModelState is Valid</span><br><span class="line">[14:15:45 INF] Executed handler method OnGet, returned result .</span><br><span class="line">[14:15:45 INF] Executing an implicit handler method - ModelState is Valid</span><br><span class="line">[14:15:45 INF] Executed an implicit handler method, returned result Microsoft.AspNetCore.Mvc.RazorPages.PageResult.</span><br><span class="line">[14:15:45 INF] Executed page /Index <span class="keyword">in</span> 124.7462ms</span><br><span class="line">[14:15:45 INF] Executed endpoint <span class="string">'/Index'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional Log from Serilog</span></span><br><span class="line">[14:15:45 INF] HTTP GET / responded 200 <span class="keyword">in</span> 249.6985 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># Standard logging from ASP.NET Core infrastructure</span></span><br><span class="line">[14:15:45 INF] Request finished <span class="keyword">in</span> 274.283ms 200 text/html; charset=utf-8</span><br></pre></td></tr></table></figure>
<p>关于上面的日志消息，有几点要注意：</p>
<ul>
<li>一条Serilog日志消息就包含您想要的大多数相关信息，HTTP方法、URL路径、状态代码、持续时间。</li>
<li>Serilog日志记录的持续时间比ASP.NET Core日志记录的持续时间要短。这是正常的，因为Serilog是在进入自己的中间件时才开始计时，直到响应（ response ）被创建并返回后才停止。</li>
<li>不管使用ASP.NET Core日志组件，还是使用Serilog日志，附加属性也都会被正常记录到结构化日志中。 例如，RequestId和SpanId（<a href="https://devblogs.microsoft.com/aspnet/improvements-in-net-core-3-0-for-troubleshooting-and-monitoring-distributed-apps/" target="_blank" rel="noopener">用于跟踪功能</a>），都会作为日志附加信息而被记录。 seq的请求的以下图像中看到这一点。</li>
<li>默认配置下，会丢失一些信息。 例如，端点名称和Razor页面处理程序被丢失了。 在后续文章中，我将演示如何将它们添加到摘要日志中。</li>
</ul>
<p><img src="/images/loading.svg" data-original="https://cdn.ibestread.com/img/seq_request_logging.png" alt=""></p>
<p>剩下的工作就是过滤掉“Information”级别的日志消息了。回到<em>Program.cs</em>中，调整代码，添加额外的过滤器：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Log.Logger = <span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">    .MinimumLevel.Debug()</span><br><span class="line">    .MinimumLevel.Override(<span class="string">"Microsoft"</span>, LogEventLevel.Information)</span><br><span class="line">    <span class="comment">// Filter out ASP.NET Core infrastructre logs that are Information and below</span></span><br><span class="line">    .MinimumLevel.Override(<span class="string">"Microsoft.AspNetCore"</span>, LogEventLevel.Warning) </span><br><span class="line">    .Enrich.FromLogContext()</span><br><span class="line">    .WriteTo.Console()</span><br><span class="line">    .WriteTo.Seq(<span class="string">"http://localhost:5341"</span>)</span><br><span class="line">    .CreateLogger();</span><br></pre></td></tr></table></figure>
<p>现在您的日志会变得既简洁又清晰，每条日志均包含请求的摘要日志信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[14:29:53 INF] HTTP GET / responded 200 <span class="keyword">in</span> 129.9509 ms</span><br><span class="line">[14:29:56 INF] HTTP GET /Privacy responded 200 <span class="keyword">in</span> 10.0724 ms</span><br><span class="line">[14:29:57 INF] HTTP GET / responded 200 <span class="keyword">in</span> 3.3341 ms</span><br><span class="line">[14:30:54 INF] HTTP GET /Missing responded 404 <span class="keyword">in</span> 16.7119 ms</span><br></pre></td></tr></table></figure>
<p>本系列后面的文章会介绍如何在日志中附加额外信息。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我介绍了如何使用Serilog.AspNetCore的<code>RequestLoggingMiddleware</code>中间件，来减少为每次请求生成的日志数量，并同时记录摘要信息。 如果您已经在使用Serilog，则非常容易启用。 只需在<em>Startup.cs</em>文件中调用<code>UseSerilogRequestLogging()</code>。</p>
<p>当请求到达此中间件时，它将开启计时，当后续的中间件生成响应（或引发异常）时，响应将经过请求记录器后被返回，记录器会记录摘要日志消息。</p>
<p>添加<code>RequestLoggingMiddleware</code>中间件之后，可以过滤指定日志级别的日志，并不会丢失有用的信息。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Akini Xu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.ibestread.com/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/">https://blog.ibestread.com/using-serilog-aspnetcore-in-asp-net-core-3-reducing-log-verbosity/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.ibestread.com">嘉阅</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ASP-NET-CORE/">ASP.NET CORE</a><a class="post-meta__tags" href="/tags/ASP-NET-CORE-3-0/">ASP.NET CORE 3.0</a><a class="post-meta__tags" href="/tags/%E6%97%A5%E5%BF%97/">日志</a><a class="post-meta__tags" href="/tags/Serilog/">Serilog</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.ibestread.com/img/ali_pay_code.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://cdn.ibestread.com/img/tencent_pay_code.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e2ecc1ad505208a" async></script><nav id="pagination"><div class="next-post pull-right"><a href="/using-serilog-aspnetcore-in-asp-net-core-3/"><span>系列-在ASP.NET Core 3.0中使用Serilog</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '627199878458c320fb74',
  clientSecret: '6e48bd6ac85dffc40aa34fa8cffd72b96517a294',
  repo: 'iBestRead.github.io',
  owner: 'iBestRead',
  admin: 'akinix',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://cdn.ibestread.com/img/top_background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 By Akini Xu</div><div class="footer_custom_text"><a href="http://www.beianbeian.com/beianxinxi/305c139fe2263063db72af4e473d63d7.html" target="_blank" rel="noopener">粤ICP备17015620号</a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body></html>